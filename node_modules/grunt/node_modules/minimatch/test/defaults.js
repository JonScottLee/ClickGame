// http://www.bashcookbook.com/bashinfo/source/bash-1.14.7/tests/glob-test
//
// TODO: Some of these tests do very bad things with backslashes, and will
// most likely fail badly on windows.  They should probably be skipped.

var tap = require("tap")
  , globalBefore = Object.keys(global)
  , mm = require("../")
  , files = [ "a", "b", "c", "d", "abc"
            , "abd", "abe", "bb", "bcd"
            , "ca", "cb", "dd", "de"
            , "bdir/", "bdir/cfile"]
  , next = files.concat([ "a-b", "aXb"
                        , ".x", ".y" ])

tap.test("basic tests", function (t) {
  var start = Date.now()

  // [ pattern, [matches], MM opts, files, TAP opts]
  ; [ "http://www.bashcookbook.com/bashinfo" +
      "/source/bash-1.14.7/tests/glob-test"
    , ["a*", ["a", "abc", "abd", "abe"]]
    , ["X*", ["X*"], {nonull: true}]

    // allow null glob expansion
    , ["X*", []]

    // isaacs: Slightly different than bash/sh/ksh
    // \\* is not un-escaped to literal "*" in a failed match,
    // but it does make it get treated as a literal star
    , ["\\*", ["\\*"], {nonull: true}]
    , ["\\**", ["\\**"], {nonull: true}]
    , ["\\*\\*", ["\\*\\*"], {nonull: true}]

    , ["b*/", ["bdir/"]]
    , ["c*", ["c", "ca", "cb"]]
    , ["**", files]

    , ["\\.\\./*/", ["\\.\\./*/"], {nonull: true}]
    , ["s/\\..*//", ["s/\\..*//"], {nonull: true}]

    , "legendary larry crashes bashes"
    , ["/^root:/{s/^[^:]*:[^:]*:\([^:]*\).*$/\\1/"
      , ["/^root:/{s/^[^:]*:[^:]*:\([^:]*\).*$/\\1/"], {nonull: true}]
    , ["/^root:/{s/^[^:]*:[^:]*:\([^:]*\).*$/\1/"
      , ["/^root:/{s/^[^:]*:[^:]*:\([^:]*\).*$/\1/"], {nonull: true}]

    , "character classes"
    , ["[a-c]b*", ["abc", "abd", "abe", "bb", "cb"]]
    , ["[a-y]*[^c]", ["abd", "abe", "bb", "bcd",
       "bdir/", "ca", "cb", "dd", "de"]]
    , ["a*[^c]", ["abd", "abe"]]
    , function () { files.push("a-b", "aXb") }
    , ["a[X-]b", ["a-b", "aXb"]]
    , function () { files.push(".x", ".y") }
    , ["[^a-c]*", ["d", "dd", "de"]]
    , function () { files.push("a*b/", "a*b/ooo") }
    , ["a\\*b/*", ["a*b/ooo"]]
    , ["a\\*?/*", ["a*b/ooo"]]
    , ["*\\\\!*", [], {null: true}, ["echo !7"]]
    , ["*\\!*", ["echo !7"], null, ["echo !7"]]
    , ["*.\\*", ["r.*"], null, ["r.*"]]
    , ["a[b]c", ["abc"]]
    , ["a[\\b]c", ["abc"]]
    , ["a?c", ["abc"]]
    , ["a\\*c", [], {null: true}, ["abc"]]
    , ["", [""], { null: true }, [""]]

    , "http://www.opensource.apple.com/source/bash/bash-23/" +
      "bash/tests/glob-test"
    , function () { files.push("man/", "man/man1/", "man/man1/bash.1") }
    , ["*/man*/bash.*", ["man/man1/bash.1"]]
    , ["man/man1/bash.1", ["man/man1/bash.1"]]
    , ["a***c", ["abc"], null, ["abc"]]
    , ["a*****?c", ["abc"], null, ["abc"]]
    , ["?*****??", ["abc"], null, ["abc"]]
    , ["*****??", ["abc"], null, ["abc"]]
    , ["?*****?c", ["abc"], null, ["abc"]]
    , ["?***?****c", ["abc"], null, ["abc"]]
    , ["?***?****?", ["abc"], null, ["abc"]]
    , ["?***?****", ["abc"], null, ["abc"]]
    , ["*******c", ["abc"], null, ["abc"]]
    , ["*******?", ["abc"], null, ["abc"]]
    , ["a*cd**?**??k", ["abcdecdhjk"], null, ["abcdecdhjk"]]
    , ["a**?**cd**?**??k", ["abcdecdhjk"], null, ["abcdecdhjk"]]
    , ["a**?**cd**?**??k***", ["abcdecdhjk"], null, ["abcdecdhjk"]]
    , ["a**?**cd**?**??***k", ["abcdecdhjk"], null, ["abcdecdhjk"]]
    , ["a**?**cd**?**??***k**", ["abcdecdhjk"], null, ["abcdecdhjk"]]
    , ["a****c**?**??*****", ["abcdecdhjk"], null, ["abcdecdhjk"]]
    , ["[-abc]", ["-"], null, ["-"]]
    , ["[abc-]", ["-"], null, ["-"]]
    , ["\\", ["\\"], null, ["\\"]]
    , ["[\\\\]", ["\\"], null, ["\\"]]
    , ["[[]", ["["], null, ["["]]
    , ["[", ["["], null, ["["]]
    , ["[*", ["[abc"], null, ["[abc"]]
    , "a right bracket shall lose its special meaning and\n" +
      "represent itself in a bracket expression if it occurs\n" +
      "first in the list.  -- POSIX.2 2.8.3.2"
    , ["[]]", ["]"], null, ["]"]]
    , ["[]-]", ["]"], null, ["]"]]
    , ["[a-\z]", ["p"], null, ["p"]]
    , ["??**********?****?", [], { null: true }, ["abc"]]
    , ["??**********?****c", [], { null: true }, ["abc"]]
    , ["?************c****?****", [], { null: true }, ["abc"]]
    , ["*c*?**", [], { null: true }, ["abc"]]
    , ["a*****c*?**", [], { null: true }, ["abc"]]
    , ["a********???*******", [], { null: true }, ["abc"]]
    , ["[]", [], { null: true }, ["a"]]
    , ["[abc", [], { null: true }, ["["]]

    , "nocase tests"
    , ["XYZ", ["xYz"], { nocase: true, null: true }
      , ["xYz", "ABC", "IjK"]]
    , ["ab*", ["ABC"], { nocase: true, null: true }
      , ["xYz", "ABC", "IjK"]]
    , ["[ia]?[ck]", ["ABC", "IjK"], { nocase: true, null: true }
      , ["xYz", "ABC", "IjK"]]

    // [ pattern, [matches], MM opts, files, TAP opts]
    , "onestar/twostar"
    , ["{/*,*}", [], {null: true}, ["/asdf/asdf/asdf"]]
    , ["{/?,*}", ["/a", "bb"], {null: true}
      , ["/a", "/b/b", "/a/b/c", "bb"]]

    , "dots should not match unless requested"
    , ["**", ["a/b"], {}, ["a/b", "a/.d", ".a/.d"]]

    // .. and . can only match patterns starting with .,
    // even when options.dot is set.
    , function () {
        files = ["a/./b", "a/../b", "a/c/b", "a/.d/b"]
      }
    , ["a/*/b", ["a/c/b", "a/.d/b"], {dot: true}]
    , ["a/.*/b", ["a/./b", "a/../b", "a/.d/b"], {dot: true}]
    , ["a/*/b", ["a/c/b"], {dot:false}]
    , ["a/.*/b", ["a/./b", "a/../b", "a/.d/b"], {dot: false}]


    // this also tests that changing the options needs
    // to change the cache key, even if the pattern is
    // the same!
    , ["**", ["a/b","a/.d",".a/.d"], { dot: true }
      , [ ".a/.d", "a/.d", "a/b"]]

    , "paren sets cannot contain slashes"
    , ["*(a/b)", ["*(a/b)"], {nonull: true}, ["a/b"]]

    // brace sets trump all else.
    //
    // invalid glob pattern.  fails on bash4 and bsdglob.
    // however, in this implementation, it's easier just
    // to do the intuitive thing, and let brace-expansion
    // actually come before parsing any extglob patterns,
    // like the documentation seems to say.
    //
    // XXX: if anyone complains about this, either fix it
    // or tell them to grow up and stop complaining.
    //
    // bash/bsdglob says this:
    // , ["*(a|{b),c)}", ["*(a|{b),c)}"], {}, ["a", "ab", "ac", "ad"]]
    // but we do this instead:
    , ["*(a|{b),c)}", ["a", "ab", "ac"], {}, ["a", "ab", "ac", "ad"]]

    // test partial parsing in the presence of comment/negation chars
    , ["[!a*", ["[!ab"], {}, ["[!ab", "[ab"]]
    , ["[#a*", ["[#ab"], {}, ["[#ab", "[ab"]]

    // like: {a,b|c\\,d\\\|e} except it's unclosed, so it has to be escaped.
    , ["+(a|*\\|c\\\\|d\\\\\\|e\\\\\\\\|f\\\\\\\\\\|g"
      , ["+(a|b\\|c\\\\|d\\\\|e\\\\\\\\|f\\\\\\\\|g"]
      , {}
      , ["+(a|b\\|c\\\\|d\\\\|e\\\\\\\\|f\\\\\\\\|g", "a", "b\\c"]]


    // crazy nested {,,} and *(||) tests.
    , function () {
        files = [ "a", "b", "c", "d"
                , "ab", "ac", "ad"
                , "bc", "cb"
                , "bc,d", "c,db", "c,d"
                , "d)", "(b|c", "*(b|c"
                , "b|c", "b|cc", "cb|c"
                , "x(a|b|c)", "x(a|c)"
                , "(a|b|c)", "(a|c)"]
      }
    , ["*(a|{b,c})", ["a", "b", "c", "ab", "ac"]]
    , ["{a,*(b|c,d)}", ["a","(b|c", "*(b|c", "d)"]]
    // a
    // *(b|c)
    // *(b|d)
    , ["{a,*(b|{c,d})}", ["a","b", "bc", "cb", "c", "d"]]
    , ["*(a|{b|c,c})", ["a", "b", "c", "ab", "ac", "bc", "cb"]]


    // test various flag settings.
    , [ "*(a|{b|c,c})", ["x(a|b|c)", "x(a|c)", "(a|b|c)", "(a|c)"]
      , { noext: true } ]
    , ["a?b", ["x/y/acb", "acb/"], {matchBase: true}
      , ["x/y/acb", "acb/", "acb/d/e", "x/y/acb/d"] ]
    , ["#*", ["#a", "#b"], {nocomment: true}, ["#a", "#b", "c#d"]]


    // begin channelling Boole and deMorgan...
    , "negation tests"
    , function () {
        files = ["d", "e", "!ab", "!abc", "a!b", "\\!a"]
      }

    // anything that is NOT a* matches.
    , ["!a*", ["\\!a", "d", "e", "!ab", "!abc"]]

    // anything that IS !a* matches.
    , ["!a*", ["!ab", "!abc"], {nonegate: true}]

    // anything that IS a* matches
    , ["!!a*", ["a!b"]]

    // anything that is NOT !a* matches
    , ["!\\!a*", ["a!b", "d", "e", "\\!a"]]

    // negation nestled within a pattern
    , function () {
        files = [ "foo.js"
                , "foo.bar"
                // can't match this one without negative lookbehind.
                , "foo.js.js"
                , "blar.js"
                , "foo."
                , "boo.js.boo" ]
      }
    , ["*.!(js)", ["foo.bar", "foo.", "boo.js.boo"] ]

    ].forEach(function (c) {
      if (typeof c === "function") return c()
      if (typeof c === "string") return t.comment(c)

      var pattern = c[0]
        , expect = c[1].sort(alpha)
        , options = c[2] || {}
        , f = c[3] || files
        , tapOpts = c[4] || {}

      // options.debug = true
      var Class = mm.defaults(options).Minimatch
      var m = new Class(pattern, {})
      var r = m.makeRe()
      tapOpts.re = String(r) || JSON.stringify(r)
      tapOpts.files = JSON.stringify(f)
      tapOpts.pattern = pattern
      tapOpts.set = m.set
      tapOpts.negated = m.negate

      var actual = mm.match(f, pattern, options)
      actual.sort(alpha)

      t.equivalent( actual, expect
                  , JSON.stringify(pattern) + " " + JSON.stringify(expect)
                  , tapOpts )
    })

  t.comment("time=" + (Date.now() - start) + "ms")
  t.end()
})

tap.test("global leak test", function (t) {
  var globalAfter = Object.keys(global)
  t.equivalent(globalAfter, globalBefore, "no new globals, please")
  t.end()
})

function alpha (a, b) {
  return a > b ? 1 : -1
}
 =:ô*RIZß%S5C∫<L?í	„ø5yºxCf.gí‘MÌBÙ›ü∑ã¸„ÜEpí$ƒÅœ÷j”≠‘—∂nÂ—„s™÷£Ÿb≤¨ïëS¯)∞ó„˙öS√7!wAL˛†Wü´Ÿœ’gûñ$ì‘fe«í)kÍ ˚ !„œ~¡Qc”°À›ÉÊ‚ßπJ˛4–r® ¥H<(Ç∞j5©Ó(ˆç"|˜è#oîïUc≠%dÄmíë1˙†‚îõp…^(Óm–f™b-‚<?1º¿>h∞§c,Pë5…“\èÇÄ-4πüØ∂9ç‚‰±F<‹P6êù≤—Ñ≤∞©&Yt∫∂ÔWæ¶täÙl}¬∂!çp(H˛Ø C˚L›#‘“©P´“£(◊ €á5ç3IßJé∏÷TøpÁbrû(%⁄∞+G€5M;kï∏›‘AÍèNöº® ≠œÁ=øãpËºX,˘ÀlpπYMË∫4f¬´îŸu ÃKEs'k•)IÜÃ{ƒA?WE.~ßƒM!ÀÂÕ˙ûö≠˝€c,H;{Û#:˚Aåï—?a8ÜJM
0“íPT[öK√Eˇ®¿‹:!|@˚≈:C◊h˜†s≥{˜U”¨ñ»◊èPFB,ìÕZ≥Ö±˝≤ûöv=á`¨~µhf-g]≈ﬂ/ÇÊ$øÑºH#.èÑ÷¯ˇÄÓ£Å«Ã–WÇæEYˆSWúÎö¢—Ù9Ò¸ãóL>òÚHÍﬁQ¨˛˜4í˝¸‚W;BiÚFH ße3˙ c,œÜÅfRVXCEnHµsfusﬂ6Su-áï‰W¨˝Õ5O68Wß§Ûé4 æ9öå%“;`ˇ–$BwU˝≥RF:Ê‚Ω›Ø/
1™¯sﬁ0˝‹ÃÚË^èÅ'Äü‘òRªXﬁï¡©Å⁄#,2ç¡£gkEXs|π$”Í32[”ü«ô†É√¢»‡öé/≥byo5uPduF÷g{Sèh|?¶¸¢û˚ù#ú˜Æ9Õ2Ë,±ÃËí“ûWÅ\
R<=“>ü∏7¬_;ÊÜ⁄m¥’
‚â∏˘ƒI‰oápı0»¯º˛	~LÛﬂ0íÈ*î2&4™	≥ˇtLØ9›Êà°¡Îå∫˙¿a9àÑwπK0Ωû >∆VLM†±ücI{:Tõ€ï˜Ál î\¡∫ó˚XÂ˛ín∆4˙	æÀJ?KÃ·ÿ,±˚7jò££·1‚ÍâΩ‘Oïñ+∂xÇ(¬_†¥v}ÌÖvf|-^wÊ6é3n˘ªπ¶Û7\‡#^.ΩD9_QÓªFeŸÏz–>S?óy[_t`◊Ö5ú≥¡Æî‰≤ÊgX¨Væ5D¯Sﬂü6‚Qìä∞˛C_®.ÒeﬂC∞mòÉÎbôäè?∑ìqMπ-{í2∂ÿ@ó}CÊ·ò»éÃy·0‰ı(á≥+à:si?•P≥áÕÿ∞ë\4.≤»k Î\èÈH&Û≥Y“ À˜œZMH_)7e#‹Â7Y'#˘•µ°—pÍMµ¢Â—ÛLœ“ÍÃ®≈:lwu‹àêqà	òÿ?«1“•ƒ≥•êí%H4v‡<D…g8$Px`œ'ôx©ï_”Æly®gïPL`œ.pãò_W9s£UïÔk¡˝•bìï]iﬂ<˚È\	∫ŸÁÈ'Û
˜›·”∂sÉ]‰*1ü˚*¸ÀQ´S≤[(qCìó& ÁUˆœgqe∏CZ˝~rWêEUoUY™πS¥‡WˇÀÔà€ú'è0Zá¢ª·Örù÷€2u8/µ¡ˆÍ#û4MÏπ…FyIjıMÜ‘Ï,RµOª&Ïl˛r‘•úrÇáá“á£!ùﬁs, •b>•PLG8\õ7J%;◊[lV:≤∂c9Aïx∏ΩΩ◊¢å&66‚m^¶r#õﬁ øˇüÇ∆TäJ?ÇU~Ω!n\ù˘C¯ì†Ò¯∆·JÓ5<d9√·æ„ZßxÀ™”Ñ⁄„p≈Œ˙Øß‰–y”r÷≈˝ΩtƒÖ»ÙßMC˙1˜cç©Tã—ıªòÓ˘êÖ»Oœˆ´·ùcâåÂIY]∑ÈkÀ^jÑ3ı»eY……|!yH®5r( $o®[–2¿„≤≥¸ï‰^àß@SuAœ™≠lƒ®êVYBÄ´èÃG ·RÊ"\a⁄yuÙ"õ†ªñ¢î—§ΩE¸äSN6Ñ¯Ä˙†kÈÒ@ûé" ∆ºx[vÙjÃºtØŸ&ÊÓÉ˚◊/Ì∑ÂWt_ˇD:Æ÷€ŒŸÏÇ}%õ—S÷Ö @=K¡/B$Ë“7xPüŸnı\®™püÖDªT»ËtÔÅÂÇ¶Ê6ÆBPÕ?¬VL´IﬂÕéõæ˘´‘Ñ⁄uz<%O SƒhCÍ¯†6•Y(ÒÛ›ù/ﬁDìΩ+ïTÖsÄﬂ˘i‚Æp∂"”l‘kC-•~¡?2Ì}G∞û>ó»Úwz°/*SIŸÓ“í£t«7uë>ÚÓÖ´"√0Çæ	Ñ‡gµ!qˆô6”/˙Û8ﬂÔ™˘Ç≈î¿Ÿπ€:÷‹ﬂl^ºŒ¯$ÂN2√àò0™î¶~àñf8ÿe IÏYŒ~!q£©eÏÉ”¸Ñ”gpL«\£<ˆŒıÊ{Ë≥=ÀÂræ·v0√jñ∏†-*8*üÿ;L §Eﬂ8;+J i_ıA∑∂†çÎOEk"Í∞ò¢öÙ©!…ﬁ&¿?%˙eÛŸ.ﬁ\;ÃcÆ„"C± µìyg·Ãxcç”gÁEª%˙÷G≈bv•S–['Ùq paKΩ∂¥ÅfV#$⁄•sı¶∏9JÒº…‘Qî7Ì~,?ª*Õ[/DàHÓP£m© 1ccu|•SIí¬ìAçÂ∂ﬁ◊œÈÊÒ–˜nªﬂ˚?£ı:”∂"Öâ®µaK(Et◊uvãh—‹àÅ‚(S=,˝$W–Õ‘@Ùí.¯¶†?	cø¥≠—#ö~ÃééK‚	rJﬂ’\/ï&“≥˚·r#™πOÒçÒÓz=∞uM,ı¶éªÿå∂ß
óbvŸ0ÔäÍU`^®akILe‰$6ó;Î¬yæ2ˇAùckœK©Ôû≤Û©\˛§¨éÿ€ïÈÁi;„ÛÔ4g√Y_d®XÛ)B≠`Z@ztW∫H›Îw3÷O‡"≠P„”SÁIXŸY ∞Àó`sît·/®rD≥mCΩvCl(çOÔ1'5°,Yõ’˘Î èG|ŒrQëam=¸'h$≥ÊÍ€
Ç\úâDà˛?‡§æÓvÍılÙù≥Û7€†µ≤Â
ÃNåü,ˇﬁUä~“Z∏£úœØ?√”;Hè›n oóY'Ó ˜vjD´%¸